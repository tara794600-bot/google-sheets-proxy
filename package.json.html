<script>

  document.addEventListener("DOMContentLoaded", function() {
	setTimeout(function() {
	  const targetElement = document.getElementById("oms-shop-payment");

	  if (targetElement) {
		const element = targetElement.querySelectorAll(".css-2nfxqo");
		// const innerElement = element[2].querySelector(".css-1ojf7x");
        const innerElement = element[2].children[0];
        
		const formElement = innerElement.querySelector("form");
  
		const selectedOption = element[0].querySelector('.css-15fzge').textContent;
		// 정규표현식을 사용하여 필요한 데이터 추출
		const input01 = formElement.children[02].children[1].children[0].children[0];
		const inputbox01 = formElement.children[02];
		inputbox01.style.overflow = 'hidden';
		inputbox01.style.height = '0px';
		inputbox01.style.marginTop = '-20px';

		const input02 = formElement.children[5].children[1].children[0].children[0];
		const inputbox02 = formElement.children[5];
		inputbox02.style.overflow = 'hidden';
		inputbox02.style.height = '0px';
		inputbox02.style.marginTop = '-20px';

		// 맡기기 찾기 폼 만들기
		// <div class="do-fr" id="do-form">
		const doForm = document.createElement('div');
		doForm.classList.add('do-fr');
		doForm.id = 'do-form';

		// <div style="display: grid; grid-template-columns: 1fr 1fr; column-gap: 20px; width: 100%;">
		const gridContainer = document.createElement('div');
		gridContainer.style.display = 'grid';
		gridContainer.style.gridTemplateColumns = '1fr 1fr';
		gridContainer.style.columnGap = '20px';
		gridContainer.style.width = '100%';

		// <div id="startDayInput" style="width: 100%;">
		const startDayInput = document.createElement('div');
		startDayInput.id = 'startDayInput';
		startDayInput.style.width = '100%';

		// <div class="do-title">맡기는 날</div>
		const startDayTitle = document.createElement('div');
		startDayTitle.classList.add('do-title');
		startDayTitle.textContent = '맡기는 날';

		// startDayInput에 title 추가
		startDayInput.appendChild(startDayTitle);

		// <div id="endDayInput" style="width: 100%;">
		const endDayInput = document.createElement('div');
		endDayInput.id = 'endDayInput';
		endDayInput.style.width = '100%';

		// <div class="do-title">찾는 날</div>
		const endDayTitle = document.createElement('div');
		endDayTitle.classList.add('do-title');
		endDayTitle.textContent = '찾는 날';

		// endDayInput에 title 추가
		endDayInput.appendChild(endDayTitle);

		// gridContainer에 startDayInput과 endDayInput 추가
		gridContainer.appendChild(startDayInput);
		gridContainer.appendChild(endDayInput);

		// doForm에 gridContainer 추가 이걸 다섯번째에 집어넣어줘
		doForm.appendChild(gridContainer);

		// 7번째 요소 찾아 집어넣기
		const insertBox = formElement.children[6];
		formElement.insertBefore(doForm, insertBox);



		let selectedStartDay = '';
		let selectedEndDay = '';

		// 1-1. selectedOption 파싱 및 startShop, endShop 설정
		// let [startPart, endPart] = selectedOption.split(/ \/ \d+마리 \/ /);
		// let [startPart, endPart] = selectedOption.split(/\s*\/\s*\d+마리(?:~\d+마리)?\s*\/\s*/);
		let [startPart, endPart] = selectedOption.split(/\s*\/\s*(?:\d+마리|\d+~\d+마리)\s*\/\s*/);
		let [startShopName, startDayPart] = startPart.split('//맡기는날-');
		let [endShopName, endDayPart] = endPart.split('//찾는날-');
        
		const regex = /[^-\s]+[-\s]+([가-힣a-zA-Z0-9()]+)/;
		const match = startShopName.trim().match(regex);
		let startShop = diboShopData.find(shop => match[1] === shop.name) || {};
		let endShop = diboShopData.find(shop => endShopName.trim().includes(shop.name)) || {};
		let startDay = startDayPart.split('.').map(day => day.trim());
		// let endDay = endDayPart.split(',').map(day => day.trim());
        
        
		let endDay = endDayPart.split('.').map(day => {
		  let parts = day.trim().split(' '); // '토 -1개'를 '토'와 '-1개'로 나눔
		  if (parts[1]) {
			return parts[0]; // '토'만 반환
		  }
		  return day.trim();
		});
        
		// 2. 오늘 날짜부터 10일 후까지의 날짜 생성
		function getDatesInRange(startDate, days) {
		  let dates = [];
		  for (let i = 0; i < days; i++) {
			let date = new Date(startDate);
			date.setDate(date.getDate() + i);
			dates.push(date);
		  }
		  return dates;
		}

		let today = new Date();
		let instStartDays = getDatesInRange(today, 15).map(date => date.toISOString().split('T')[0]);

		// 3. 요일 필터링 및 휴일 처리
		function getFilteredDates(dates, days, holidays) {
		  const dayMap = ['일', '월', '화', '수', '목', '금', '토'];

		  // 3-1. 요일 필터링
		  let filteredDates = dates.filter(date => {
			let dayOfWeek = dayMap[new Date(date).getDay()];
			return days.includes(dayOfWeek);
		  });
		
		  // 3-2. 휴일 처리: 휴일과 겹치는 날짜 제외, 휴일 전날만 추출
		  let insteadDay = [];
		  filteredDates = filteredDates.filter(date => {
			let dayOfWeek = dayMap[new Date(date).getDay()];
			if (holidays && holidays.includes(dayOfWeek)) {
			  let newDate = new Date(date);
			  newDate.setDate(newDate.getDate() - 1); // 하루 전으로 변경
			  insteadDay.push(newDate.toISOString().split('T')[0]);
			  return false; // 휴일과 겹치는 날짜 제외
			}
			return true;
		  });

		  return { filteredDates, insteadDay };
		}

		let { filteredDates, insteadDay } = getFilteredDates(instStartDays, startDay, startShop.holiday ? startShop.holiday.split(',').map(day => day.trim()) : []);

		// 4. 날짜 합치기 및 정렬
		let allDates = Array.from(new Set([...filteredDates, ...insteadDay]));
		allDates.sort((a, b) => new Date(a) - new Date(b));
		let startDays = allDates;

		const startDayInputid = document.getElementById('startDayInput')
		const selectElement = document.createElement('select');
		selectElement.classList.add('do-select-bd');
		// 기본 안내 옵션 추가
		const defaultOption = document.createElement('option');
		defaultOption.value = ''; // 기본 값은 빈 문자열로 설정
		defaultOption.textContent = '맡기는 날 선택';
		defaultOption.disabled = true; // 선택 불가능하도록 설정
		defaultOption.selected = true; // 기본으로 선택된 상태로 설정
		selectElement.appendChild(defaultOption);

		startDays.forEach(date => {
		  const option = document.createElement('option');
		  option.value = date;
		  option.textContent = date;
		  selectElement.appendChild(option);
		});

		startDayInputid.appendChild(selectElement);

		const endDayInputid = document.getElementById('endDayInput');
		const selectEndelement = document.createElement('select');
		selectEndelement.classList.add('do-select-bd');
		// 기본 안내 옵션 추가
		const defaultEndOption = document.createElement('option');
		defaultEndOption.value = ''; // 기본 값은 빈 문자열로 설정
		defaultEndOption.textContent = '찾는날 선택';
		defaultEndOption.disabled = true; // 선택 불가능하도록 설정
		defaultEndOption.selected = true; // 기본으로 선택된 상태로 설정
		selectEndelement.appendChild(defaultEndOption);


		endDayInputid.appendChild(selectEndelement);
		// 6. 선택된 날짜 저장 및 endDays 생성

		selectElement.addEventListener('change', (event) => {
		  selectedStartDay = event.target.value;
		  // 맡기는날 입력폼에 저장
		  input01.value = selectedStartDay;
		  input01.dispatchEvent(new Event("change", { bubbles: true }));
		  
		  // 방문 요일 데이터 파싱 (공백을 고려하여 정규식 사용)
		  const visitDays = startShop.visit.split(/,\s*/).map(day => day.trim()); // ["화", "토"]

		  // 요일을 숫자로 변환하는 매핑 (일: 0, 월: 1, ..., 토: 6)
		  const dayMap = { "일": 0, "월": 1, "화": 2, "수": 3, "목": 4, "금": 5, "토": 6 };
		  const visitDayNumbers = visitDays.map(day => dayMap[day]);
		  console.log("방문 요일:", visitDays);
		  
		  // 날짜 변환
		  let visitDay = null;
		  let tempDate = new Date(selectedStartDay);
		  
		  for (let i = 0; i <= 7; i++) { // 0부터 시작해야 현재 요일도 바로 체크
			const year = tempDate.getFullYear();
			const month = String(tempDate.getMonth() + 1).padStart(2, "0"); // 월 보정 (1~12)
			const day = String(tempDate.getDate()).padStart(2, "0");
			const formattedDate = `${year}-${month}-${day}`;
			
			if (visitDayNumbers.includes(tempDate.getDay())) {
			  visitDay = formattedDate;
			  //console.log(visitDay);
			  break;
			}
			tempDate.setDate(tempDate.getDate() + 1); // 하루씩 증가
		  }
		  
		  // console.log(visitDay);
		  
		  // 예외처리 코드
          
         function getDeliveryStartDate(baseDate, startShop, endShop) {
          const start = new Date(baseDate);
  
          // 출발지와 도착 샵 이름 추출
          const fromArea = startShop.area || '';
          const toShop = endShop.name || '';
  
          // 예외 목록에서 매칭되는 항목 찾기
          const exception = deliveryExceptions.find(item =>
            fromArea.includes(item.fromArea) && toShop === item.toShop
          );
  
          const addDays = exception ? exception.days : 1; // 매칭되면 예외일, 없으면 기본 1일
          start.setDate(start.getDate() + addDays);

          console.log(addDays)
          return start.toISOString().split('T')[0];
        }
		  
		  selectedStartDay = getDeliveryStartDate(visitDay, startShop, endShop);
          const startDate = new Date(selectedStartDay);
		  
		  selectedStartDay = startDate.toISOString().split('T')[0]; 
		  console.log(selectedStartDay)
		  
		  // instEndDays 생성
		  let instEndDays = getDatesInRange(new Date(selectedStartDay), 15).map(date => date.toISOString().split('T')[0]);
		  let { filteredDates: filteredEndDates, insteadDay: insteadEndDay } = getFilteredDates(
			instEndDays,
			endDay,
			endShop.holiday ? endShop.holiday.split(',').map(day => day.trim()) : []
		  );

		  // 날짜 합치기 및 정렬
		  let allEndDates = Array.from(new Set([...filteredEndDates, ...insteadEndDay]));
		  allEndDates.sort((a, b) => new Date(a) - new Date(b));
          
		  // 기존 selectEndelement의 옵션 초기화
		  selectEndelement.innerHTML = '';
		  defaultEndOption.value = ''; // 기본 값은 빈 문자열로 설정
		  defaultEndOption.textContent = '찾는날 선택';
		  defaultEndOption.disabled = true; // 선택 불가능하도록 설정
		  defaultEndOption.selected = true;

		  // allEndDates.forEach(date => {
		  // const option = document.createElement('option');
		  // option.value = date;
		  // option.textContent = date;
		  // selectEndelement.appendChild(option);
		  // });
		  
		  // 첫 번째 날짜만 추가
		  if (allEndDates.length > 0) {
			const option = document.createElement('option');
			option.value = allEndDates[0];
			option.textContent = allEndDates[0];
			selectEndelement.appendChild(option);
		  }
		  
		  endDayInput.appendChild(selectEndelement);
		  selectEndelement.appendChild(defaultEndOption);

		});

		selectEndelement.addEventListener('change', (event) => {
		  selectedEndDay = event.target.value;
		  // 찾는날 입력폼에 저장
		  input02.value = selectedEndDay;
		  input02.dispatchEvent(new Event("change", { bubbles: true }));
		});

	  }
	}, 2500); 

  });
</script>




<script>
  document.addEventListener("DOMContentLoaded", function() {
    setTimeout(function() {
      const targetElement = document.getElementById("oms-shop-payment");

      if (targetElement) {
        const element = targetElement.querySelectorAll(".css-2nfxqo");
        const innerElement = element[2].children[0];
        const formElement = innerElement.querySelector("form");

        const selectedOption = element[0].querySelector('.css-15fzge').textContent;
        const input01 = formElement.children[2].children[1].children[0].children[0];
        const inputbox01 = formElement.children[2];
        inputbox01.style.overflow = 'hidden';
        inputbox01.style.height = '0px';
        inputbox01.style.marginTop = '-20px';

        const input02 = formElement.children[5].children[1].children[0].children[0];
        const inputbox02 = formElement.children[5];
        inputbox02.style.overflow = 'hidden';
        inputbox02.style.height = '0px';
        inputbox02.style.marginTop = '-20px';

        // 맡기기 찾기 폼 만들기
        const doForm = document.createElement('div');
        doForm.classList.add('do-fr');
        doForm.id = 'do-form';

        const gridContainer = document.createElement('div');
        gridContainer.style.display = 'grid';
        gridContainer.style.gridTemplateColumns = '1fr 1fr';
        gridContainer.style.columnGap = '20px';
        gridContainer.style.width = '100%';

        const startDayInput = document.createElement('div');
        startDayInput.id = 'startDayInput';
        startDayInput.style.width = '100%';

        const startDayTitle = document.createElement('div');
        startDayTitle.classList.add('do-title');
        startDayTitle.textContent = '맡기는 날';
        startDayInput.appendChild(startDayTitle);

        const endDayInput = document.createElement('div');
        endDayInput.id = 'endDayInput';
        endDayInput.style.width = '100%';

        const endDayTitle = document.createElement('div');
        endDayTitle.classList.add('do-title');
        endDayTitle.textContent = '찾는 날';
        endDayInput.appendChild(endDayTitle);

        gridContainer.appendChild(startDayInput);
        gridContainer.appendChild(endDayInput);
        doForm.appendChild(gridContainer);

        const insertBox = formElement.children[6];
        formElement.insertBefore(doForm, insertBox);

        let selectedStartDay = '';
        let selectedEndDay = '';

        // 선택된 옵션 파싱
        let [startPart, endPart] = selectedOption.split(/\s*\/\s*(?:\d+마리|\d+~\d+마리)\s*\/\s*/);
        let [startShopName, startDayPart] = startPart.split('//맡기는날-');
        let [endShopName, endDayPart] = endPart.split('//찾는날-');

        const regex = /[^-\s]+[-\s]+([가-힣a-zA-Z0-9()]+)/;
        const match = startShopName.trim().match(regex);
        let startShop = diboShopData.find(shop => match[1] === shop.name) || {};
        let endShop = diboShopData.find(shop => endShopName.trim().includes(shop.name)) || {};
        let startDay = startDayPart.split('.').map(day => day.trim());
        let endDay = endDayPart.split('.').map(day => {
          let parts = day.trim().split(' ');
          if (parts[1]) {
            return parts[0];
          }
          return day.trim();
        });

        // 날짜 범위 생성
        function getDatesInRange(startDate, days) {
          let dates = [];
          for (let i = 0; i < days; i++) {
            let date = new Date(startDate);
            date.setDate(date.getDate() + i);
            dates.push(date);
          }
          return dates;
        }

        let today = new Date();
        let instStartDays = getDatesInRange(today, 15).map(date => date.toISOString().split('T')[0]);

        // 요일 및 휴일 처리
        function getFilteredDates(dates, days, holidays) {
          const dayMap = ['일', '월', '화', '수', '목', '금', '토'];
          let filteredDates = dates.filter(date => {
            let dayOfWeek = dayMap[new Date(date).getDay()];
            return days.includes(dayOfWeek);
          });

          let insteadDay = [];
          filteredDates = filteredDates.filter(date => {
            let dayOfWeek = dayMap[new Date(date).getDay()];
            if (holidays && holidays.includes(dayOfWeek)) {
              let newDate = new Date(date);
              newDate.setDate(newDate.getDate() - 1);
              insteadDay.push(newDate.toISOString().split('T')[0]);
              return false;
            }
            return true;
          });

          return { filteredDates, insteadDay };
        }

        let { filteredDates, insteadDay } = getFilteredDates(
          instStartDays,
          startDay,
          startShop.holiday ? startShop.holiday.split(',').map(day => day.trim()) : []
        );

        let allDates = Array.from(new Set([...filteredDates, ...insteadDay]));
        allDates.sort((a, b) => new Date(a) - new Date(b));
        let startDays = allDates;

        // 맡기는 날 select
        const startDayInputid = document.getElementById('startDayInput');
        const selectElement = document.createElement('select');
        selectElement.classList.add('do-select-bd');

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '맡기는 날 선택';
        defaultOption.disabled = true;
        defaultOption.selected = true;
        selectElement.appendChild(defaultOption);

        startDays.forEach(date => {
          const option = document.createElement('option');
          option.value = date;
          option.textContent = date;
          selectElement.appendChild(option);
        });

        startDayInputid.appendChild(selectElement);

        // 찾는 날 select
        const endDayInputid = document.getElementById('endDayInput');
        const selectEndelement = document.createElement('select');
        selectEndelement.classList.add('do-select-bd');

        const defaultEndOption = document.createElement('option');
        defaultEndOption.value = '';
        defaultEndOption.textContent = '찾는날 선택';
        defaultEndOption.disabled = true;
        defaultEndOption.selected = true;
        selectEndelement.appendChild(defaultEndOption);

        endDayInputid.appendChild(selectEndelement);

        // 맡기는 날 선택 이벤트
        selectElement.addEventListener('change', (event) => {
          selectedStartDay = event.target.value;
          input01.value = selectedStartDay;
          input01.dispatchEvent(new Event("change", { bubbles: true }));

          const visitDays = startShop.visit.split(/,\s*/).map(day => day.trim());
          const dayMap = { "일": 0, "월": 1, "화": 2, "수": 3, "목": 4, "금": 5, "토": 6 };
          const visitDayNumbers = visitDays.map(day => dayMap[day]);

          let visitDay = null;
          let tempDate = new Date(selectedStartDay);

          for (let i = 0; i <= 7; i++) {
            const year = tempDate.getFullYear();
            const month = String(tempDate.getMonth() + 1).padStart(2, "0");
            const day = String(tempDate.getDate()).padStart(2, "0");
            const formattedDate = `${year}-${month}-${day}`;

            if (visitDayNumbers.includes(tempDate.getDay())) {
              visitDay = formattedDate;
              break;
            }
            tempDate.setDate(tempDate.getDate() + 1);
          }

          // 예외처리 함수
          function getDeliveryStartDate(baseDate, startShop, endShop) {
            const start = new Date(baseDate);
            const fromArea = startShop.area || '';
            const toShop = endShop.name || '';
            const exception = deliveryExceptions.find(item =>
              fromArea.includes(item.fromArea) && toShop === item.toShop
            );
            const addDays = exception ? exception.days : 1;
            start.setDate(start.getDate() + addDays);
            return start.toISOString().split('T')[0];
          }

          selectedStartDay = getDeliveryStartDate(visitDay, startShop, endShop);
          const startDate = new Date(selectedStartDay);
          selectedStartDay = startDate.toISOString().split('T')[0];

          let instEndDays = getDatesInRange(new Date(selectedStartDay), 15).map(date => date.toISOString().split('T')[0]);
          let { filteredDates: filteredEndDates, insteadDay: insteadEndDay } = getFilteredDates(
            instEndDays,
            endDay,
            endShop.holiday ? endShop.holiday.split(',').map(day => day.trim()) : []
          );

          // 바뀐부분 시작
          // 날짜 합치기 및 정렬
          let allEndDates = Array.from(new Set([...filteredEndDates, ...insteadEndDay]));
          allEndDates.sort((a, b) => new Date(a) - new Date(b));

          // ✅ 휴가기간 필터링
          if (endShop.vacation_start && endShop.vacation_end) {
            const vStart = new Date(endShop.vacation_start);
            const vEnd = new Date(endShop.vacation_end);
            allEndDates = allEndDates.filter(dateStr => {
              const d = new Date(dateStr);
              return d < vStart || d > vEnd; // 휴가 기간 제외
            });
          }
          // 바뀐부분 끝

          // 기존 옵션 초기화
          selectEndelement.innerHTML = '';
          const defaultEndOption = document.createElement('option');
          defaultEndOption.value = '';
          defaultEndOption.textContent = '찾는날 선택';
          defaultEndOption.disabled = true;
          defaultEndOption.selected = true;
          selectEndelement.appendChild(defaultEndOption);

          if (allEndDates.length > 0) {
            const option = document.createElement('option');
            option.value = allEndDates[0];
            option.textContent = allEndDates[0];
            selectEndelement.appendChild(option);
          }

          endDayInput.appendChild(selectEndelement);
        });

        // 찾는 날 선택 이벤트
        selectEndelement.addEventListener('change', (event) => {
          selectedEndDay = event.target.value;
          input02.value = selectedEndDay;
          input02.dispatchEvent(new Event("change", { bubbles: true }));
        });

      }
    }, 2500);
  });
</script>
